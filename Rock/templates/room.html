<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock N Roll - Room</title>
</head>
<body>

<h2>Welcome to Room: <span id="room_code_display"></span></h2>

<button onclick="leaveRoom()">Leave Room</button>

<hr>

<h3>Add Song to Queue</h3>
<input type="text" id="search_input" placeholder="Paste YouTube URL">
<button onclick="AddToQueue()">Add</button>

<hr>

<h3>Queue:</h3>
<div id="queue_list"></div>

<script>

// ======================== TOKEN HELPERS ========================
function getAccessToken() { return localStorage.getItem("access"); }
function getRefreshToken() { return localStorage.getItem("refresh"); }

// ======================== SAFE FETCH FUNCTION ========================
async function fetchWithAuth(url, options = {}) {
    let token = getAccessToken();

    if (!options.headers) options.headers = {};
    options.headers["Authorization"] = "Bearer " + token;

    if (options.method && options.method !== "GET") {
        options.headers["Content-Type"] = "application/json";
    }

    let response;

    // üî• Catch network-level errors (server down etc.)  
    try {
        response = await fetch(url, options);
    } catch (e) {
        return {
            ok: false,
            status: 0,
            data: { error: "Network error ‚Äî server unreachable" }
        };
    }

    // üîÅ Auto refresh token if expired  
    if (response.status === 401) {
        const refreshRes = await fetch("/refresh/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh: getRefreshToken() })
        });

        let newTok;
        try { newTok = await refreshRes.json(); } catch { newTok = {}; }

        if (newTok.access) {
            localStorage.setItem("access", newTok.access);
            options.headers["Authorization"] = "Bearer " + newTok.access;
            response = await fetch(url, options);
        }
    }

    // üî• Safely parse JSON WITHOUT causing console error  
    let data;
    try {
        data = await response.json();
    } catch (err) {
        data = { error: "Invalid server response" };
    }

    return { ok: response.ok, status: response.status, data };
}

// ======================== LOAD ROOM ========================
async function loadRoomDetails() {
    const res = await fetchWithAuth("/api/detail_room/", { method: "GET" });

    if (!res.ok) {
        alert("Failed to load room");
        return;
    }

    document.getElementById("room_code_display").innerText = res.data.room_code;
}

// ======================== LEAVE ROOM ========================
async function leaveRoom() {
    const res = await fetchWithAuth("/api/leave_room/", { method: "POST" });

    alert(res.data.message);
    window.location.href = "/home/";
}

// ======================== LOAD QUEUE ========================
async function loadQueue() {
    const res = await fetchWithAuth("/api/room_songs/", { method: "GET" });

    const list = document.getElementById("queue_list");
    list.innerHTML = "";

    if (!res.ok) {
        list.innerHTML = "<p>Error loading queue</p>";
        return;
    }

    if (!Array.isArray(res.data)) return;

    res.data.forEach(song => addSongToDOM(song));
}

// ======================== ADD TO QUEUE ========================
async function AddToQueue() {
    const url = document.getElementById("search_input").value.trim();

    if (!url) {
        alert("Please enter a YouTube URL");
        return;
    }

    const res = await fetchWithAuth("/api/add_song/", {
        method: "POST",
        body: JSON.stringify({ url })
    });

    // ‚ö†Ô∏è SAFE ERROR HANDLING  
    if (!res.ok) {
        if (res.data.url) {
            alert(res.data.url[0]);   // serializer error  
        } else if (res.data.error) {
            alert(res.data.error);    // server message  
        } else {
            alert("Invalid YouTube URL or server error");
        }
        return;
    }

    loadQueue();  // reload queue
}

// ======================== DISPLAY SONG ========================
function addSongToDOM(song) {
    const div = document.createElement("div");
    div.style.margin = "12px 0";

    div.innerHTML = `
        <img src="${song.thumbnail}" width="120"><br>
        <b>${song.title}</b><br>
        <button onclick="voteSong(${song.id})">Vote</button>
        <hr>
    `;

    document.getElementById("queue_list").appendChild(div);
}

// ======================== VOTE ========================
async function voteSong(songId) {
    const res = await fetchWithAuth("/api/vote_song/", {
        method: "POST",
        body: JSON.stringify({ song_id: songId })
    });

    alert(res.data.message);
    loadQueue();
}

// ======================== PAGE LOAD ========================
window.onload = function() {
    loadRoomDetails();
    loadQueue();
};

</script>

</body>
</html>
