<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock N Roll - Room</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #player {
            width: 640px;
            height: 360px;
            background: black;
            margin-bottom: 10px;
        }
        img {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h2>Room Code: <span id="room_code_display"></span></h2>
<button onclick="leaveRoom()">Leave Room</button>

<hr>

<!-- PLAYER -->
<div id="player"></div>

<button onclick="mute()">Mute</button>
<button onclick="unmute()">Unmute</button>

<hr>

<h3>Add Song</h3>
<input type="text" id="search_input" placeholder="Paste YouTube URL">
<button onclick="addToQueue()">Add</button>

<hr>

<h3>Queue</h3>
<div id="queue_list"></div>

<script>
/* ================= GLOBALS ================= */
let player = null;
let playerReady = false;
let currentRoomSongId = null;

/* ================= TOKEN HELPERS ================= */
function getAccessToken() { return localStorage.getItem("access"); }
function getRefreshToken() { return localStorage.getItem("refresh"); }

/* ================= FETCH WITH AUTH ================= */
async function fetchWithAuth(url, options = {}) {
    if (!options.headers) options.headers = {};
    options.headers["Authorization"] = "Bearer " + getAccessToken();

    if (options.method && options.method !== "GET") {
        options.headers["Content-Type"] = "application/json";
    }

    let response = await fetch(url, options);

    if (response.status === 401) {
        const r = await fetch("/api/token/refresh/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh: getRefreshToken() })
        });

        const data = await r.json();
        localStorage.setItem("access", data.access);

        options.headers["Authorization"] = "Bearer " + data.access;
        response = await fetch(url, options);
    }

    let data = {};
    try { data = await response.json(); } catch {}
    return { ok: response.ok, data };
}

/* ================= ROOM DETAILS ================= */
async function loadRoomDetails() {
    const res = await fetchWithAuth("/api/room/detail/");
    if (res.ok) {
        document.getElementById("room_code_display").innerText = res.data.room_code;
    }
}

(function loadYouTubeAPI() {
    if (window.YT && window.YT.Player) return;

    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    tag.async = true;

    tag.onerror = function () {
        console.error("YouTube API blocked. Retrying...");
        setTimeout(loadYouTubeAPI, 3000);
    };

    document.head.appendChild(tag);
})();
/* ================= LEAVE ROOM ================= */
async function leaveRoom() {
    await fetchWithAuth("/api/room/leave/", { method: "POST" });
    window.location.href = "/home/";
}

/* ================= QUEUE ================= */
async function loadQueue() {
    const res = await fetchWithAuth("/api/songs/queue/");
    if (!res.ok) return;

    const list = document.getElementById("queue_list");
    list.innerHTML = "";

    res.data.forEach(song => {
        list.innerHTML += `
            <div>
                <img src="${song.thumbnail}" width="120"><br>
                <b>${song.title}</b><br>
                Votes: ${song.vote_count}<br>
                <button onclick="voteSong(${song.id})">
                    ${song.has_voted ? "Unvote" : "Vote"}
                </button>
                <hr>
            </div>
        `;
    });
}

/* ================= ADD SONG ================= */
async function addToQueue() {
    const url = document.getElementById("search_input").value.trim();
    if (!url) return alert("Paste YouTube URL");

    const res = await fetchWithAuth("/api/songs/add/", {
        method: "POST",
        body: JSON.stringify({ url })
    });

    if (!res.ok) alert(res.data.error || "Error adding song");

    document.getElementById("search_input").value = "";
    loadQueue();
}

/* ================= VOTE ================= */
async function voteSong(id) {
    await fetchWithAuth(`/api/songs/${id}/vote/`, { method: "POST" });
    loadQueue();
}

/* ================= YOUTUBE PLAYER ================= */
function onYouTubeIframeAPIReady() {
    console.log("YouTube API loaded");

    player = new YT.Player("player", {
        height: "360",
        width: "640",
        playerVars: {
            autoplay: 1,
            mute: 1,
            rel: 0,
            enablejsapi: 1,
            origin: window.location.origin
        },
        events: {
            onReady: () => {
                console.log("Player ready");
                playerReady = true;
                player.mute();
            },
            onStateChange: onPlayerStateChange
        }
    });
}

function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.ENDED) {
        fetchWithAuth("/api/songs/play-next/", { method: "POST" });
    }
}

/* ================= NOW PLAYING ================= */
async function syncNowPlaying() {
    if (!playerReady) return;

    const res = await fetchWithAuth("/api/songs/now-playing/");
    if (!res.ok || !res.data.video_id) return;

    if (currentRoomSongId !== res.data.room_song_id) {
        currentRoomSongId = res.data.room_song_id;
        player.loadVideoById(res.data.video_id);
        player.playVideo();
    }
}

/* ================= CONTROLS ================= */
function mute() { if (playerReady) player.mute(); }
function unmute() { if (playerReady) player.unMute(); }

/* ================= INIT ================= */
window.onload = () => {
    loadRoomDetails();
    loadQueue();

    setInterval(loadQueue, 3000);

    setTimeout(() => {
        setInterval(syncNowPlaying, 2000);
    }, 1500);
};
</script>

</body>
</html>
