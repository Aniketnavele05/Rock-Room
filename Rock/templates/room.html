<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock N Roll - Room</title>
</head>
<body>

<h2>Welcome to Room: <span id="room_code_display"></span></h2>

<button onclick="leaveRoom()">Leave Room</button>

<hr>

<h3>Search Songs:</h3>
<input type="text" id="search_input" placeholder="Search song..." onkeyup="searchSong()">

<ul id="results"></ul>

<button onclick="goToLeaderboard()">Leaderboard</button>

<script>

// ---------- JWT Helpers ----------
function getAccessToken() {
    return localStorage.getItem("access");
}
function getRefreshToken() {
    return localStorage.getItem("refresh");
}

async function fetchWithAuth(url, options = {}) {
    let token = getAccessToken();

    if (!options.headers) options.headers = {};

    options.headers["Authorization"] = "Bearer " + token;

    // Add JSON header only for POST / PUT
    if (options.method !== "GET") {
        options.headers["Content-Type"] = "application/json";
    }

    let response = await fetch(url, options);

    // If token expired -> refresh
    if (response.status === 401) {
        let refreshRes = await fetch("/refresh/", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ refresh: getRefreshToken() })
        });

        let newTok = await refreshRes.json();
        localStorage.setItem("access", newTok.access);

        options.headers["Authorization"] = "Bearer " + newTok.access;
        response = await fetch(url, options);
    }

    return response.json();
}

// ---------- Load Room ----------
async function loadRoomDetails() {
    const data = await fetchWithAuth("/api/detail_room/", { method: "GET" });

    if (!data.room_code) {
        alert("No room found");
        window.location.href = "/home/";
        return;
    }

    document.getElementById("room_code_display").innerText = data.room_code;
}

// ---------- Leave Room ----------
async function leaveRoom() {
    const data = await fetchWithAuth("/api/leave_room/", { method: "POST" });
    alert(data.message);
    window.location.href = "/home/";
}

// ---------- Search Song ----------
async function searchSong() {
    const query = document.getElementById("search_input").value;
    if (!query) return;

    const data = await fetchWithAuth(`/api/search_song/?q=${encodeURIComponent(query)}`, {
        method: "GET"
    });

    const resultsBox = document.getElementById("results");
    resultsBox.innerHTML = "";

    data.results.forEach(song => {
        const li = document.createElement("li");
        li.innerHTML = `
            <img src="${song.thumbnail}" width="80">
            <strong>${song.title}</strong>
            <button onclick="voteSong('${song.video_id}')">Vote</button>
        `;
        resultsBox.appendChild(li);
    });
}

// ---------- Vote ----------
async function voteSong(videoId) {
    const data = await fetchWithAuth("/api/vote_song/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ song_id: videoId })
    });

    alert(data.message);
}

// ---------- Leaderboard ----------
function goToLeaderboard() {
    window.location.href = "/leaderboard/";
}

window.onload = loadRoomDetails;

</script>

</body>
</html>
