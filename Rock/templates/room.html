<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock N Roll - Room</title>
</head>
<body>

<h2>Welcome to Room: <span id="room_code_display"></span></h2>

<button onclick="leaveRoom()">Leave Room</button>

<hr>

<h3>Song URL Enter Here:</h3>
<input type="text" id="search_input" placeholder="Paste YouTube URL">
<button onclick="AddToQueue()">Add</button>

<hr>

<div id="queue_list">
    <!-- Songs will appear here -->
</div>

<script>

// ---------- JWT Helpers ----------
function getAccessToken() {
    return localStorage.getItem("access");
}
function getRefreshToken() {
    return localStorage.getItem("refresh");
}

async function fetchWithAuth(url, options = {}) {
    let token = getAccessToken();

    if (!options.headers) options.headers = {};

    options.headers["Authorization"] = "Bearer " + token;

    if (options.method !== "GET") {
        options.headers["Content-Type"] = "application/json";
    }

    let response = await fetch(url, options);

    if (response.status === 401) {
        let refreshRes = await fetch("/refresh/", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ refresh: getRefreshToken() })
        });

        let newTok = await refreshRes.json();
        localStorage.setItem("access", newTok.access);

        options.headers["Authorization"] = "Bearer " + newTok.access;
        response = await fetch(url, options);
    }

    return response.json();
}

// ---------- Load Room ----------
async function loadRoomDetails() {
    const data = await fetchWithAuth("/api/detail_room/", { method: "GET" });

    if (!data.room_code) {
        alert("No room found");
        window.location.href = "/home/";
        return;
    }

    document.getElementById("room_code_display").innerText = data.room_code;
}

// ---------- Leave Room ----------
async function leaveRoom() {
    const data = await fetchWithAuth("/api/leave_room/", { method: "POST" });
    alert(data.message);
    window.location.href = "/home/";
}

// ---------- Add To Queue ----------
async function AddToQueue() {
    const url = document.getElementById("search_input").value;

    if (!url) {
        alert("Please enter a YouTube URL");
        return;
    }

    const data = await fetchWithAuth("/api/add_song/", {
        method: "POST",
        body: JSON.stringify({ url: url })    // sending URL to backend
    });

    if (data.detail) {
        alert(data.detail);
        return;
    }

    addSongToDOM(data);
}

// ---------- Display Song in Queue ----------
function addSongToDOM(song) {
    const div = document.createElement("div");
    div.style.margin = "10px 0";

    div.innerHTML = `
        <img src="${song.thumbnail}" width="120"><br>
        <b>${song.title}</b><br>
        <button onclick="voteSong(${song.id})">Vote</button>
        <hr>
    `;

    document.getElementById("queue_list").appendChild(div);
}

// ---------- Vote ----------
async function voteSong(songId) {
    const data = await fetchWithAuth("/api/vote_song/", {
        method: "POST",
        body: JSON.stringify({ song_id: songId })
    });

    alert(data.message);
}

window.onload = loadRoomDetails;

</script>

</body>
</html>
